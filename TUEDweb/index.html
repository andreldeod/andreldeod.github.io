<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title> TUED Participating Unions </title>
        <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
        <script src='https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.js'></script>
        <link href='https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.css' rel='stylesheet' />
         
        <!-- Spiderifier Stylesheet -->
        <link href="https://cdn.jsdelivr.net/npm/mapboxgl-spiderifier@1.0.10/index.min.css" rel="stylesheet">

        <!-- Spiderifier Script -->
        <script src="https://cdn.jsdelivr.net/npm/mapboxgl-spiderifier@1.0.10/index.min.js"></script>

        <!-- CSS Links -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Familjen+Grotesk:wght@700&display=swap" rel="stylesheet">
  <!--      <link href="site.css" id="site-style" rel="stylesheet"> -->

        <!-- jQuery -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>

        <!-- Bootstrap Bundle JS (Includes Popper) -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <!-- For excel reading-->
        <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>




 
        <style>
            /* Define a base font stack */
            :root {
                --base-font-family: Calibri, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            }

            /* Apply the font family broadly */
            html, body, .mapboxgl-popup-content, ul, li, .side-panel, .initial-panel {
                font-family: var(--base-font-family);
            }


            html, body {
                margin: 0; 
                padding: 0;
                background-color: #8f474e;
                overflow-x: hidden; /* Prevents horizontal scroll */
            }
            #map {position: absolute; top: 50px; bottom: 0px; width: 100%;}

     
            
            /*style map popups*/
            .mapboxgl-popup-content {
                pointer-events: auto;
                border-radius: 4px;
                box-shadow: none;
                padding: 12px 16px;
                color: #ffffff;
                background-color: rgba(37, 37, 37, 0.8); /* 80% transparency */
            }

            /*popup bottom arrow color*/
            .mapboxgl-popup-anchor-bottom .mapboxgl-popup-tip {
                border-top-color: rgba(37, 37, 37, 0.8);
            }

            /* List item style */
            ul {
                list-style-type: disc; /* Default bullet style */
                padding-left: 20px; /* Ensures indentation of bullets */
                margin-top: 0px; /* Spacing above the list */
                margin-bottom: 0px; /* Spacing below the list */
            }

            li {
                margin-bottom: 5px; /* Adds space between items */
            }

            /* Common styles for both panels */
            .side-panel, .initial-panel {
                position: absolute;
                top: 0px;
                right: 0;
                width: 300px;
                box-shadow: -3px 0 6px rgba(0,0,0,0.2);
                transform: translateX(100%);
                transition: transform 0.3s ease-in-out;
                z-index: 2000;
                height: 100%;
            }

            .initial-panel {
                background-color: #F4EEEE;
            }

            .side-panel {
                background-color: white;
            }

            .side-panel-content, .initial-panel-content {
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                height: 100%;  
                padding: 20px;
                padding-bottom: 0; 
                box-sizing: border-box; 
                overflow-y: auto;
                }


            /* Stock image for initial panel */
            .full-width-image {
                width: calc(100% + 40px);  
                margin-left: -20px;  
                margin-right: -20px; 
                margin-top: 10px; 
                height: auto;  
                align-self: flex-end;
                
            }

            .side-panel.open, .initial-panel.open {
                transform: translateX(0);
            }

            /* Common style adjustments for headers and text within panels */
            .side-panel h1, .initial-panel h1 {
                color: #AA2130;
                font-size: 30px;
                font-family: 'Bitter', serif;
                font-weight: bold;
                margin-bottom: 10px;
            }

            .side-panel p, .side-panel h2, .side-panel a, 
            .initial-panel p, .initial-panel h2, .initial-panel a {
                color: #3A3031;
                margin-top: 0px;
            }

            /* Style for close button on pannels */
            .close-panel {
                cursor: pointer;
                background: #3A3031;
                border: none;
                color: #474747;
                padding: 10px 10px;
                margin-top: 50px;
                margin-bottom: -5px;
            }

            /* Style for union logos on side pannel */
            #union-logo {
                width: 100%;
                height: auto;
                margin-top: 0px;
                margin-bottom: 8px;
            }
            
            /* Style for top banner */
            .header {
                width: 100%;
                height: 50px;
                background-color: white;
                padding: 5px 0px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                text-align: center;
                position: fixed; /* Makes the header stay at the top when you scroll */
                top: 0; /* Aligns the header at the very top of the page */
                left: 0; /* Ensures it spans from the left edge */
                z-index: 3000; /* Ensures it stays on top of other content */
                border-bottom: 2px solid #3A3031; /* Adds a black line along the bottom */
            }

            /* Style for union photo on initial panel */
            .union-photo {
                width: 100%; /* Full width to use all available space */
                height: auto; /* Maintain aspect ratio */
                margin-top: 5px; /* Space from the last text */
                margin-bottom: 10px;
                border-top: 1px solid #ccc; /* Optional: adds a subtle separator */
                border: 5px solid #4D5D48 ; /* #752626 */
                box-sizing: border-box; /* Ensures border width is included in the width calculation */
            }

            
            /* Adds a smooth transition effect to images inside <a> tags with class 'union-photo' */
            a img.union-photo {
                transition: transform 0.3s ease-in-out; /* Smooth transition for scale */
            }

            /* Scales the image slightly and changes the cursor on hover */
            a img.union-photo:hover {
                transform: scale(1.05); /* Slightly enlarges the image on hover */
                cursor: pointer; /* Changes the cursor to indicate it's clickable */
            }

            /* Optional: Add styles for hover and active states */
            .mapboxgl-ctrl-home:hover {
                background-color: rgba(255, 255, 255, 0.4);
            }

            .mapboxgl-ctrl-home:active {
                background-color: rgba(255, 255, 255, 0.7);
            }

            /* Adjust placement of navigation controls*/
            .mapboxgl-ctrl-top-left {
                top: 15px !important; 
            }

            .navbar {
            background-color: transparent !important;  /* Keeps the navbar transparent */
            padding: 2px;
        }

        /* Making navbar buttons fully opaque */
        .navbar .nav-link.dropdown-toggle {
            background-color: #FFFFFF; /* Set a solid white background or any desired color */
            opacity: 0.9 !important; /* Ensures the button is fully opaque */
        }

        /*  Add a custom style for #unionCount so it has a fixed width and white background */
        #unionCount {
            /* Ensure it becomes a little rectangular "box" */
            display: inline-flex;
            /* Center the text horizontally & vertically */
            align-items: center;
            justify-content: center;
            /*  Make background white */
            background-color: rgba(255, 255, 255, 0.9);
            /*  Match the color (#AA2130) and font of "PARTICIPATING UNIONS" */
            color: #AA2130;
            font-family: 'Bitter', serif;
            font-size: 43.5px;
            font-weight: bold;
            /* Fixed dimensions so we get a consistent rectangle */
            width: 70px;     /* Enough to fit a 3-digit number comfortably */
        }

        /* Additional styling to ensure dropdown menus are visible against the navbar */
        .dropdown-menu {
            background-color: white; /* Ensure dropdown menus are also opaque if needed */
            opacity: 0.9;
        }
            


        </style>
    </head>
    <body>
        <!-- TOP BANNER -->
        <div class="header">
            <a href="https://www.tuedglobal.org/" target="_blank">
                <img src="TUEDlogo_layered_HORIZ.jpg" alt="TUED Logo" style="width: auto; height: 40px;"> <!-- Adjust width and height while maintaining aspect ratio -->
            </a>
        </div>
        
        <div id="map"></div>

        <!-- SIDE PANEL WITH UNION INFO-->
        <div id="side-panel" class="side-panel">
            <div class="side-panel-content">
                <button class="close-panel"> </button>
                <h1 id="union-acronym"></h1>
                <h2 id="union-name"></h2>
                <a id="union-logo-link" href="#" target="_blank">
                    <img id="union-logo" src="" alt="Union Logo" />
                  </a>                  
                <ul class="union-details" style="margin-top: 5px;">
                    <li><strong>Jurisdiction:</strong> <span id="union-jurisdiction">N/A</span></li>
                    <li><strong>Area of representation:</strong> <span id="union-area_of_representation">N/A</span></li>
                    <li><strong>Region:</strong> <span id="union-region">N/A</span></li>
                    <li><strong>Sector:</strong> <span id="union-sector">N/A</span></li>
                </ul>
                <p id="union-description" style="margin-top: 10px;"></p>
                <a id="union-link" href="#" target="_blank" style="display: block; text-align: center;">Visit Website</a>
            </div>
        </div>

        <!-- INITIAL PANEL WITH ABOUT INFO-->
        <div id="initial-panel" class="initial-panel">
            <div class="initial-panel-content">
                <button class="close-panel">  </button>
                <h1>PARTICIPATING UNIONS</h1>
                <a href="https://drive.google.com/file/d/1pIGYWBP6dVubt59lXbEtlzVuuJPyNEcL/view?usp=sharing" target="_blank">
                    <img src="groupPhoto.jpg" alt="Group Photo of Participating Unions" class="union-photo">
                </a>              
                <p><strong>Trade Unions for Energy Democracy (TUED) is a growing global network of unions working to advance democratic control and social ownership of energy, in ways that promote solutions to the climate crisis, address energy poverty, and resist the degradation of both land and people.</strong></p>
                <ul>
                    <li>Click on the points to learn more about individual unions.</li>
                    <li>Countries in yellow have at least one participating union.</li>
                    <li>For more info click <a href="https://www.tuedglobal.org/participating-unions-and-allies" target="_blank">here</a>.</li>
                </ul>
                <img src="powerLines.png" alt="Descriptive Alt Text" class="full-width-image">
                
            </div>
        </div>

        <!-- DROPDOWN FILTER MENU PANEL-->
        <div class="navbar fixed-bottom navbar-expand-sm navbar-light bg-light">
            <div class="container-fluid">
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav mb-2 mx-2 border-top border-dark shadow-sm">
                        <!-- Jurisdiction Dropdown -->
                        <li class="nav-item dropup">
                            <a class="nav-link dropdown-toggle" href="#" id="jurisdictionDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <span class="small">Select Jurisdiction</span>
                                <br>
                                <span class="h5" id="selectedJurisdictionLabel">All</span>
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="jurisdictionDropdown" id="jurisdiction_select">
                                <!--  items will be added here dynamically -->
                            </ul>
                        </li>
                        <!-- Sector Dropdown -->
                        <li class="nav-item dropup">
                            <a class="nav-link dropdown-toggle" href="#" id="sectorDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <span class="small">Select Sector</span>
                                <br>
                                <span class="h5" id="selectedSectorLabel">All</span>
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="sectorDropdown" id="sector_select">
                                <!--  items will be added here dynamically -->
                            </ul>
                        </li>
                        <!-- Region Dropdown -->
                        <li class="nav-item dropup">
                            <a class="nav-link dropdown-toggle" href="#" id="regionDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <span class="small">Select Region</span>
                                <br>
                                <span class="h5" id="selectedRegionLabel">All</span>
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="regionDropdown" id="region_select">
                                <!--  items will be added here dynamically -->
                            </ul>
                        </li>
                        <!-- Add a new list item to show the number of unions -->
                        <li class="nav-item d-flex align-items-center">
                            <span id="unionCount">0</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        

    <script>
        // MAPBOX TOKEN CODE
        mapboxgl.accessToken = 'pk.eyJ1IjoiYW5kcmxkZW9kIiwiYSI6ImNsdjJ2M2QzZjBtbnMya253NjQ2MTFzZjYifQ.dowCB4gupvS5kSkrxky-wQ';
    
        // BASEMAP
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11',
            projection: 'naturalEarth',
            center: [0, 0],
            zoom: 1.5,
            minZoom: 1.5,
            maxZoom: 14
        });
            
////////////////////////////////////////////////////////////////////////////////
    
        // REPLACE ISRAEL WITH PALESTINE ON BASEMAP

        // Function to remove labels from base map
        map.on('style.load', function() {
            // Function to remove a label by name
            function removeLabel(label) {
                map.getStyle().layers.forEach(function(layer) {
                    if (layer.type === 'symbol' && layer.layout['text-field']) {
                        const filter = map.getFilter(layer.id);
                        // Add the new filter condition
                        const newFilter = filter ? ["all", filter, ["!=", 
                            ["get", "name_en"], label]] : ["all", ["!=", 
                            ["get", "name_en"], label]];
                        map.setFilter(layer.id, newFilter);
                    }
                });
            }

            // Remove each label individually
            removeLabel("Israel");
            removeLabel("Neot Hovav");
            removeLabel("Dimona");
            removeLabel("Sheizaf");
            removeLabel("Yerucham");
            removeLabel("Beersheba");
            removeLabel("Avdat");
            removeLabel("Arad");
            removeLabel("Mitspe Ramon");
            removeLabel("Be'er Milka");
            removeLabel("Neot HaKikar");
            removeLabel("Ein Hatseva");
            removeLabel("Yevul");
            removeLabel("Tel Aviv");
            removeLabel("Rishon LeZion");
            removeLabel("Amman");
            removeLabel("Ashdod");
            removeLabel("Petah Tikva");
            removeLabel("Netanya");
            removeLabel("Arraba");
            removeLabel("Safed");
            removeLabel("Shittim");
            removeLabel("Qiryat Ata");
            removeLabel("Nahariyya");
            removeLabel("Haifa");
            removeLabel("Beer Ora");
            removeLabel("Eilat");

            
            // Add a new custom label for Palestine 
            const countryLabelLayer = map.getStyle().layers.find(layer =>
                layer.type === 'symbol' && layer.layout['text-field'] 
                    && layer.id.includes('country')
            );

            if (countryLabelLayer) {
                // Clone the layout to modify the text-size
                const layout = Object.assign({}, countryLabelLayer.layout, {
                    "text-field": ["get", "name_en"],
                    "text-size": [
                        "interpolate", ["linear"], ["zoom"],
                        1, 11,  // Font size at zoom level 1
                        5, 16,  // Font size at zoom level 5
                        10, 20, // Font size at zoom level 10
                        15, 24  // Font size at zoom level 15
                    ],
                    "visibility": "visible"
                });

                map.addLayer({
                    "id": `${countryLabelLayer.id}-palestine`,
                    "type": "symbol",
                    "source": {
                        "type": "geojson",
                        "data": {
                            "type": "FeatureCollection",
                            "features": [{
                                "type": "Feature",
                                "geometry": {
                                    "type": "Point",
                                    "coordinates": [35, 32] 
                                },
                                "properties": {
                                    "name_en": "Palestine"
                                }
                            }]
                        }
                    },
                    "layout": layout,
                    "paint": countryLabelLayer.paint
                });
            }
        });

    ////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////
        // 1) A helper function to load and parse the Excel file, returning GeoJSON
        async function loadExcelData(url) {
                // Fetch the Excel file as an ArrayBuffer
                const response = await fetch(url);
                const arrayBuffer = await response.arrayBuffer();

                // Parse it with SheetJS
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });

                // Grab the first sheet’s name
                const firstSheetName = workbook.SheetNames[0];
                // Grab that sheet
                const worksheet = workbook.Sheets[firstSheetName];

                // Convert the sheet to a JSON array of row objects
                const rows = XLSX.utils.sheet_to_json(worksheet);

                // Convert the rows to a GeoJSON FeatureCollection
                const geojson = {
                    type: "FeatureCollection",
                    features: rows.map((row) => ({
                        type: "Feature",
                        properties: {
                            // Adjust these fields to match your Excel columns
                            id: row["id"],
                            Name: row["Name"],
                            Acronym: row["Acronym"],
                            Jurisdiction: row["Jurisdiction"],
                            Area_of_representation: row["Area_of_representation"],
                            Country_HQ_Located: row["Country_HQ_Located"],
                            City_HQ_Located: row["City_HQ_Located"],
                            lat: row["lat"],
                            long: row["long"],
                            Region: row["Region"],
                            Logo: row["Logo"],
                            Sector: row["Sector"],
                            Website: row["Website"],
                            About: row["About"],
                            iso_3166_1: row["iso_3166_1"]
                        },
                        geometry: {
                            type: "Point",
                            coordinates: [
                                parseFloat(row["long"]),
                                parseFloat(row["lat"])
                            ]
                        }
                    }))
                };
                return geojson;
            }

        // 2) Replace the old "const unions = {...}" with a variable
        let unions; // We'll store the Excel-based data here

        let currentUnionCountries = new Set(); // We'll keep the latest ISO codes here

// END OF NEW INSERT
////////////////////////////////////////////////////////////////////////////////

        // LOAD THE MAP FUNCTION
        map.on('load', async function() {

            // First, load the Excel data. If your file is "myUnions.xlsx" in the same folder:
            const timestamp = new Date().getTime(); // Add a unique timestamp to prevent caching
            unions = await loadExcelData(`./ALL_TUED_UNIONS.xlsx?t=${timestamp}`);

            // Extract country codes from the loaded data and store them globally
            currentUnionCountries = getUniqueCountries(unions.features);

            // Extract country codes from the loaded data
            const unionCountries = getUniqueCountries(unions.features);

            // COMMENT: Now set the count to the total number of unions
            document.getElementById('unionCount').textContent = unions.features.length;

            // Optionally open the initial panel on map load
            document.getElementById('initial-panel').classList.add('open');
            
            // ~~~ COUNTRY BOUNDARIES SOURCE & LAYER ~~~
            // Add the vector source for country boundaries
            map.addSource('admin-0', { // Changed source name to 'country-boundaries'
                'type': 'vector',
                'url': 'mapbox://mapbox.country-boundaries-v1', // Changed URL to new source
                'promoteId': 'mapbox_id'
            });


            // Define a filter for international worldview boundaries
            let worldviewFilter = [
                "any",
                ["==", "all", ["get", "worldview"]]
            ];

            map.addLayer({
                id: 'countries-layer',
                type: 'fill',
                source: 'admin-0',
                'source-layer': 'country_boundaries',
                layout: {},
                paint: {
                    'fill-color': '#FFBD59',
                    'fill-opacity': [
                        'match',
                        ['get', 'iso_3166_1'],
                        ['AR', 'IN', 'PH', 'GR', 'KE', 'KR'], 0.23, // Lower opacity for specific countries
                        0.5 // Default opacity for other countries
                    ]
                },
                filter: [
                    'in', 
                    'iso_3166_1', 
                    ''
                ]
            });

            // Apply filter after ensuring the layer exists
            map.on('idle', function () {
                if (map.getLayer('countries-layer')) {
                    map.setFilter('countries-layer', [
                        'in', 'iso_3166_1', ...Array.from(currentUnionCountries)
                    ]);
                }
            });



            // LOAD THE UNIONS
            map.addSource('unions', {
                type: 'geojson',
                data: unions,
                cluster: true,
                clusterMaxZoom: 7, // Max zoom level to cluster
                clusterRadius: 25 // Radius of each cluster when clustering points
            });

            // Add the union cluster circles
            map.addLayer({
                id: 'clusters',
                type: 'circle',
                source: 'unions',
                filter: ['has', 'point_count'],
                paint: {
                    'circle-color': [
                        'step',
                        ['get', 'point_count'],
                        '#858585', 5,
                        '#474747', 10,
                        '#000000'
                    ],
                    'circle-radius': [
                        'step',
                        ['get', 'point_count'],
                        20, 100,
                        30, 750,
                        40
                    ]
                }
            });

                // Add the number on the cluster circles
            map.addLayer({
                id: 'cluster-count',
                type: 'symbol',
                source: 'unions',
                layout: {
                    'text-field': '{point_count_abbreviated}',
                    'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                    'text-size': 12
                },
                paint: {
                    'text-color': 'white'
                }
            });

            // Add individual union points
            map.addLayer({
                id: 'unclustered-point',
                type: 'circle',
                source: 'unions',
                filter: ['!', ['has', 'point_count']],
                paint: {
                    'circle-color': '#bd2130',
                    'circle-radius': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        1.5, 5,  // Radius at zoom level 1.5
                        7, 10    // Radius at zoom level 7
                    ],
                    'circle-stroke-width': 0

                }
            });

            // Invisible clickable layer
            map.addLayer({
                id: 'unclustered-point-clickable',
                type: 'circle',
                source: 'unions',
                filter: ['!', ['has', 'point_count']],
                paint: {
                    'circle-color': 'white',
                    'circle-opacity': 0,  // Make the layer invisible
                    'circle-radius': 15,  // Larger radius for easier clicking
                    'circle-stroke-width': 0
                }
            });


            // Code for click and zoom on clusters
            map.on('click', 'clusters', function(e) {
                var features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
                if (!features.length) {
                    return;
                }

                const targetZoom = 10; // Set your target max click zoom level
                const currentZoom = map.getZoom();

                if (currentZoom < targetZoom) {
                    map.easeTo({
                        center: e.lngLat,
                        zoom: Math.min(currentZoom + 4, targetZoom)
                    });
                }
            });

            

            // Setup popup for hover effects
            const popup = new mapboxgl.Popup({
                    closeButton: false,
                    closeOnClick: false
                });

                map.on('mouseenter', 'unclustered-point', (e) => {
                    map.getCanvas().style.cursor = 'pointer';

                    const coordinates = e.features[0].geometry.coordinates.slice();
                    const properties = e.features[0].properties;

                    // Ensure the popup appears over the correct location
                    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                    }

                    const descriptionHTML = `
                    <div style="text-align: center; font-size: 22px; margin-bottom: 8px;">
                        <strong>${properties.Acronym || ""}</strong>
                    </div>
                    <div style="text-align: center; font-size: 16px;">
                        ${properties.Name || ""}
                    </div>
                    `;
                    popup.setLngLat(coordinates).setHTML(descriptionHTML).addTo(map);
                });

                map.on('mouseleave', 'unclustered-point-clickable', () => {
                    map.getCanvas().style.cursor = '';
                    popup.remove();
                });
            // End of hover code


            // Toggle panels if not click on feature
            map.on('click', function(e) {
                // Query the map to see if any features are present at the click location
                var features = map.queryRenderedFeatures(e.point, { layers: ['clusters', 'unclustered-point-clickable'] });

                // Check if any features are found
                if (features.length === 0) {
                    // Check if both panels are currently closed
                    const isInitialPanelOpen = document.getElementById('initial-panel').classList.contains('open');
                    const isSidePanelOpen = document.getElementById('side-panel').classList.contains('open');

                    if (!isInitialPanelOpen && !isSidePanelOpen) {
                        // If both panels are closed, specifically open the initial panel
                        document.getElementById('initial-panel').classList.add('open');
                    } else {
                        // Otherwise, toggle the initial panel as before
                        togglePanel();
                    }
                }
            });


            // start side panel code
            map.on('click', 'unclustered-point-clickable', function(e) {
                const properties = e.features[0].properties;

                // Populate the side panel with data from the clicked feature
                document.getElementById('union-acronym').textContent = properties.Acronym;
                document.getElementById('union-name').textContent = properties.Name;
                // Set the 'src' of the union logo image
                document.getElementById('union-logo').src = properties.Logo;
                // Get the anchor that wraps the union logo
                const unionLogoLink = document.getElementById('union-logo-link');
                // If there's a valid website, use it as the anchor href and allow clicking
                if (properties.Website) {
                    unionLogoLink.href = properties.Website;           // Use the union's website
                    unionLogoLink.style.pointerEvents = 'auto';        // Enable pointer interaction
                } else {
                    unionLogoLink.href = '#';                          // Otherwise, no real link
                    unionLogoLink.style.pointerEvents = 'none';        // Disable clicking
                }
                document.getElementById('union-jurisdiction').textContent = properties.Jurisdiction;
                document.getElementById('union-sector').textContent = properties.Sector;
                document.getElementById('union-area_of_representation').textContent = properties.Area_of_representation;
                document.getElementById('union-region').textContent = properties.Region;
                document.getElementById('union-description').textContent = properties.About;
                document.getElementById('union-link').href = properties.Website;

                // This will open the side panel and ensure the initial panel is closed
                togglePanel('side-panel');

                // Open the side panel
                document.getElementById('side-panel').classList.add('open');
            });

            // Populate dropdowns after the map loads and the source is set
            populateDropdowns(unions);
            
            // Sets up event listeners for dropdown interactions
            setupDropdownEventListeners();  



        });         // CLOSES THE MAP LOAD FUNCTION


        // Close the initial panel
        document.querySelector('#initial-panel .close-panel').addEventListener('click', function() {
            document.getElementById('initial-panel').classList.remove('open');
        });

        // Close the side panel
        document.querySelector('#side-panel .close-panel').addEventListener('click', function() {
            document.getElementById('side-panel').classList.remove('open');
        });

        // Navigator controls
        map.addControl(new mapboxgl.NavigationControl(), 'top-left');  

        ////////////////// FUNCTIONS

        //toggle panels
        function togglePanel(panelId) {
            const panels = ['initial-panel', 'side-panel']; // List of all panel IDs
            panels.forEach(pid => {
                const panel = document.getElementById(pid);
                if (pid === panelId) {
                    // If this is the panel we want to open, and it's not already open
                    if (!panel.classList.contains('open')) {
                        panel.classList.add('open');
                    }
                } else {
                    // Ensure all other panels are closed
                    panel.classList.remove('open');
                }
            });
        }

        // Function to populate dropdown menus with sorted options
        function populateDropdowns(unions) {
            const addOptions = (selectId, options) => {
                const dropdown = $('#' + selectId);
                dropdown.empty(); // Clear existing options first
                dropdown.append('<li><a class="dropdown-item" data-value="All" href="#">All</a></li>');
                
                // Convert Set to Array, sort it alphabetically, and append each option
                Array.from(options).sort().forEach(option => {
                    dropdown.append(`<li><a class="dropdown-item" data-value="${option}" href="#">${option}</a></li>`);
                });
            };

            addOptions('jurisdiction_select', new Set(unions.features.map(feature => feature.properties.Jurisdiction)));
            addOptions('sector_select', new Set(unions.features.map(feature => feature.properties.Sector)));
            addOptions('region_select', new Set(unions.features.map(feature => feature.properties.Region)));
        }

        // Function to filter GeoJSON based on selected jurisdiction, sector, and region
        function filterGeoJSON() {
            //selecting the label texts
            let selectedJurisdiction = $('#selectedJurisdictionLabel').text();
            let selectedSector = $('#selectedSectorLabel').text();
            let selectedRegion = $('#selectedRegionLabel').text();

            // Filter the union points based on dropdown choices
            let filteredFeatures = unions.features.filter(feature => {
                return (selectedJurisdiction === 'All' || feature.properties.Jurisdiction === selectedJurisdiction) &&
                    (selectedSector === 'All' || feature.properties.Sector === selectedSector) &&
                    (selectedRegion === 'All' || feature.properties.Region === selectedRegion);
            });

            // Update the unionCount span to show how many unions match the filter
            document.getElementById('unionCount').textContent = filteredFeatures.length;

            // Build a filtered GeoJSON
            let filteredGeoJSON = {
                "type": "FeatureCollection",
                "features": filteredFeatures
            };

            // Update the unions source with the filtered data
            map.getSource('unions').setData(filteredGeoJSON);

            // Get unique country codes from the filtered features
            const unionCountries = getUniqueCountries(filteredFeatures);

            // *** CRITICAL: Store that new set in our global variable ***
            currentUnionCountries = unionCountries;

            // Then directly apply the filter (as before)
            if (map.getLayer('countries-layer')) {
                map.setFilter('countries-layer', [
                    'in', 'iso_3166_1', ...Array.from(currentUnionCountries)
                ]);
            }

            // // Construct the filter expression for the countries layer
            // const filterExpression = ['in', 'iso_3166_1', ...Array.from(unionCountries)];

            // // Apply the filter to the countries layer
            // if (map.getLayer('countries-layer')) {
            //     map.setFilter('countries-layer', filterExpression);
            // }

            // Update the paint property for conditional opacity
            map.setPaintProperty('countries-layer', 'fill-opacity', [
                'match',
                ['get', 'iso_3166_1'],
                ['AR', 'IN', 'PH', 'GR', 'KE', 'KR'], 0.25, // Lower opacity for specific countries
                0.5 // Default opacity for other countries
            ]);
        }

        // ## Helper function to get unique country ISO codes ##
        function getUniqueCountries(features) {
            return new Set(features.map(f => f.properties.iso_3166_1).filter(code => code)); // Ensure codes are not undefined
        }




        // Event listeners for dropdown selections
        function setupDropdownEventListeners() {
            $('body').on('click', '.dropdown-menu a', function() {
                let selectedValue = $(this).data('value'); // Should capture the correct value from data-value attribute
                let parentDropdown = $(this).closest('.dropup');
                let labelToUpdate = parentDropdown.find('.h5'); // Ensure this selector matches your HTML structure

                labelToUpdate.text(selectedValue); // This updates the dropdown's visible label to the selected item's value

                filterGeoJSON(); // Trigger filtering
            });
        }






        </script>
    </body>   
</html>